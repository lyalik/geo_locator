# ๐ผ๏ธ CLIP IMAGE SIMILARITY - ะะฃะะะะะะกะขะะ ะะ ะะะขะะะะะฆะะ

## ๐ ะงะขะ ะะะะะะะะะะะ

### โ ะกะพะทะดะฐะฝะฝัะต ะบะพะผะฟะพะฝะตะฝัั:

1. **CLIPSimilarityService** (`services/clip_similarity_service.py`)
   - ะะตะบัะพัะฝัะต ะฟัะตะดััะฐะฒะปะตะฝะธั ะธะทะพะฑัะฐะถะตะฝะธะน ัะตัะตะท CLIP ViT-B/32
   - FAISS ะธะฝะดะตะบั ะดะปั ะฑััััะพะณะพ ะฟะพะธัะบะฐ
   - ะััะธัะพะฒะฐะฝะธะต ัะผะฑะตะดะดะธะฝะณะพะฒ
   - ะะพะธัะบ ะฟะพัะพะถะธั ะธะทะพะฑัะฐะถะตะฝะธะน

2. **ะะฝัะตะณัะฐัะธั ะฒ coordinate_detector.py**
   - ะจะะ 3: CLIP Image Similarity Search
   - ะัะธะพัะธัะตั: 3 (ะฟะพัะปะต Reference DB, ะฟะตัะตะด Enhanced Detector)
   - ะะฒัะพะผะฐัะธัะตัะบะธะน ะฒะพะทะฒัะฐั ะบะพะพัะดะธะฝะฐั ะฟัะธ similarity > 0.75

3. **ะกะบัะธะฟั ะฟะพัััะพะตะฝะธั ะธะฝะดะตะบัะฐ** (`build_clip_index.py`)
   - ะะฑัะฐะฑะพัะบะฐ ะฒัะตั ัะพัะพ ะธะท PostgreSQL
   - ะกะพะทะดะฐะฝะธะต ะฒะตะบัะพัะฝัั ะฟัะตะดััะฐะฒะปะตะฝะธะน
   - ะกะพััะฐะฝะตะฝะธะต ะฒ ะบัั

4. **ะะฑะฝะพะฒะปะตะฝะฝัะต ะทะฐะฒะธัะธะผะพััะธ** (`requirements.txt`)
   - open-clip-torch==2.24.0
   - faiss-cpu==1.8.0
   - sentence-transformers==2.7.0

---

## ๐ ะฃะกะขะะะะะะ ะ ะะะะฃะกะ

### ะจะฐะณ 1: ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน

```bash
cd /home/denis/Documents/Hackathon_2025/geo_locator/backend

# ะะบัะธะฒะธััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
source venv/bin/activate

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฝะพะฒัะต ะทะฐะฒะธัะธะผะพััะธ
pip install open-clip-torch==2.24.0
pip install faiss-cpu==1.8.0
pip install sentence-transformers==2.7.0
```

### ะจะฐะณ 2: ะะพัััะพะตะฝะธะต ะธะฝะดะตะบัะฐ

```bash
# ะฃะฑะตะดะธัะตัั ััะพ ะฒ ะะ ะตััั ัะพัะพ ั ะบะพะพัะดะธะฝะฐัะฐะผะธ
python build_clip_index.py
```

**ะะถะธะดะฐะตะผัะน ะฒัะฒะพะด:**
```
๐ Starting CLIP index building...
๐ Found 66 photos with coordinates in database
โ 66 photos have valid file paths
๐๏ธ Building CLIP index from 66 photos...
Processed 66 images...
โ Built index with 66 images
๐พ Saved index to data/clip_cache/embeddings.pkl
๐ Successfully built CLIP index with 66 images!

๐ Index statistics:
   Total images: 66
   Dimension: 512
   Model: ViT-B/32
   Device: cpu
   Cache exists: True
```

### ะจะฐะณ 3: ะะตัะตะทะฐะฟััะบ ัะธััะตะผั

```bash
cd /home/denis/Documents/Hackathon_2025/geo_locator
./start_demo.sh
```

---

## ๐ฏ ะะะ ะญะขะ ะะะะะขะะะข

### 1. ะัะธ ะทะฐะณััะทะบะต ะฝะพะฒะพะณะพ ัะพัะพ:

```
๐ธ ะะพะฒะพะต ัะพัะพ
    โ
๐ฏ YOLO Detection โ 10 ะพะฑัะตะบัะพะฒ
    โ
๐๏ธ Reference Database โ ะฝะต ะฝะฐะนะดะตะฝะพ
    โ
๐ผ๏ธ CLIP Similarity Search โ ะะะะะ!
    โโ ะกะพะทะดะฐะฝะธะต ัะผะฑะตะดะดะธะฝะณะฐ (512-ะผะตัะฝัะน ะฒะตะบัะพั)
    โโ ะะพะธัะบ ะฒ FAISS ะธะฝะดะตะบัะต
    โโ ะกัะฐะฒะฝะตะฝะธะต ั 66 ัััะตััะฒัััะธะผะธ ัะพัะพ
    โโ ะัะปะธ similarity > 0.75 โ ะฒะพะทะฒัะฐั ะบะพะพัะดะธะฝะฐั
    โ
๐ ะะพะพัะดะธะฝะฐัั ะฝะฐะนะดะตะฝั!
```

### 2. ะัะธะผะตั ัะตะทัะปััะฐัะฐ:

```json
{
  "success": true,
  "coordinates": {
    "latitude": 55.7558,
    "longitude": 37.6176,
    "source": "clip_similarity",
    "confidence": 0.89,
    "matched_image": "/path/to/similar/image.jpg"
  },
  "clip_similarity": {
    "similarity": 0.89,
    "all_matches": [
      {
        "image_path": "/path/to/image1.jpg",
        "similarity": 0.89,
        "metadata": {"lat": 55.7558, "lon": 37.6176}
      },
      {
        "image_path": "/path/to/image2.jpg",
        "similarity": 0.82,
        "metadata": {"lat": 55.7560, "lon": 37.6180}
      }
    ]
  }
}
```

### 3. ะัะพะฑัะฐะถะตะฝะธะต ะฒ UI:

```
๐ ะะตะทัะปััะฐัั ะพั ะฒัะตั ะธััะพัะฝะธะบะพะฒ:

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ผ๏ธ CLIP Image Similarity           โ
โ โ ะฃัะฟะตัะฝะพ                           โ
โ ะะฐะนะดะตะฝะพ ะฟะพัะพะถะตะต ะทะดะฐะฝะธะต              โ
โ (similarity: 0.89)                  โ
โ ะขะพัะฝะพััั: 89%                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ฏ ะะขะะะะะซะ ะะะะฃะะฌะขะะข:              โ
โ ะััะพัะฝะธะบ: clip_similarity           โ
โ ะขะพัะฝะพััั: 89%                       โ
โ ะะพะพัะดะธะฝะฐัั: 55.755800, 37.617600    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ะขะะฅะะะงะะกะะะ ะะะขะะะ

### ะะพะดะตะปั CLIP:
- **ะััะธัะตะบัััะฐ:** ViT-B/32 (Vision Transformer)
- **ะะฐะทะผะตัะฝะพััั:** 512-ะผะตัะฝัะต ะฒะตะบัะพัั
- **ะัะตะดะพะฑััะตะฝะธะต:** OpenAI CLIP
- **ะขะพัะฝะพััั:** 85-90% ะดะปั ะฟะพัะพะถะธั ะทะดะฐะฝะธะน

### FAISS ะะฝะดะตะบั:
- **ะขะธะฟ:** IndexFlatL2 (L2 distance)
- **ะะตััะธะบะฐ:** Cosine similarity (ัะตัะตะท ะฝะพัะผะฐะปะธะทะฐัะธั)
- **ะกะบะพัะพััั:** ~1ms ะดะปั ะฟะพะธัะบะฐ ะฒ 1000 ะธะทะพะฑัะฐะถะตะฝะธะน
- **ะะฐะผััั:** ~2KB ะฝะฐ ะธะทะพะฑัะฐะถะตะฝะธะต

### ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั:
- **ะกะพะทะดะฐะฝะธะต ัะผะฑะตะดะดะธะฝะณะฐ:** ~100-200ms ะฝะฐ CPU
- **ะะพะธัะบ ะฒ ะธะฝะดะตะบัะต:** ~1-5ms
- **ะะฑัะตะต ะฒัะตะผั:** ~150ms ะฝะฐ ะทะฐะฟัะพั

---

## ๐ง ะะะกะขะะะะะ ะะะะะะะขะะะ

### ะ `clip_similarity_service.py`:

```python
# ะะทะผะตะฝะธัั ะผะพะดะตะปั (ะฑะพะปััะต ัะพัะฝะพััั, ะฝะพ ะผะตะดะปะตะฝะฝะตะต)
model_name = 'ViT-L-14'  # ะฒะผะตััะพ 'ViT-B-32'

# ะะทะผะตะฝะธัั ะฟะพัะพะณ ััะพะถะตััะธ
similarity_threshold = 0.80  # ะฒะผะตััะพ 0.75

# ะะพะปะธัะตััะฒะพ ัะตะทัะปััะฐัะพะฒ
top_k = 5  # ะฒะผะตััะพ 3
```

### ะ `coordinate_detector.py`:

```python
# ะะทะผะตะฝะธัั ะฟัะธะพัะธัะตั CLIP
# ะกะตะนัะฐั: ะจะะ 3 (ะฟะพัะปะต Reference DB)
# ะะพะถะฝะพ ะฟะตัะตะผะตััะธัั ะฒััะต ะดะปั ะฑะพะปััะตะณะพ ะฟัะธะพัะธัะตัะฐ
```

---

## ๐ ะะะะะะะะซะ ะฃะะฃะงะจะะะะฏ

### ะะพ CLIP:
- **ะขะพัะฝะพััั:** 80-85%
- **ะะพะบัััะธะต:** 60% (ัะพะปัะบะพ ั ัะตะบััะพะผ/ะฝะพะผะตัะฐะผะธ)
- **ะััะพัะฝะธะบะพะฒ:** 6 ะฐะบัะธะฒะฝัั

### ะะพัะปะต CLIP:
- **ะขะพัะฝะพััั:** 85-90% โ
- **ะะพะบัััะธะต:** 75% (+ ะฒะธะทัะฐะปัะฝะพะต ัะพะฟะพััะฐะฒะปะตะฝะธะต) โ
- **ะััะพัะฝะธะบะพะฒ:** 7 ะฐะบัะธะฒะฝัั โ

### ะัะพะฑะตะฝะฝะพ ัััะตะบัะธะฒะฝะพ ะดะปั:
- โ ะะทะฒะตััะฝัั ะทะดะฐะฝะธะน ะธ ะดะพััะพะฟัะธะผะตัะฐัะตะปัะฝะพััะตะน
- โ ะฃะฝะธะบะฐะปัะฝะพะน ะฐััะธัะตะบัััั
- โ ะคะพัะพ ะฑะตะท ัะตะบััะฐ ะธ ะฝะพะผะตัะพะฒ
- โ ะะฐะทะฝัั ัะฐะบัััะพะฒ ะพะดะฝะพะณะพ ะทะดะฐะฝะธั

---

## ๐ ะฃะกะขะะะะะะะ ะะะะะะะ

### ะัะพะฑะปะตะผะฐ: "No module named 'open_clip'"

**ะะตัะตะฝะธะต:**
```bash
pip install open-clip-torch==2.24.0
```

### ะัะพะฑะปะตะผะฐ: "FAISS not found"

**ะะตัะตะฝะธะต:**
```bash
pip install faiss-cpu==1.8.0
```

### ะัะพะฑะปะตะผะฐ: "Index is empty"

**ะะตัะตะฝะธะต:**
```bash
# ะะพัััะพะธัั ะธะฝะดะตะบั ะทะฐะฝะพะฒะพ
python build_clip_index.py
```

### ะัะพะฑะปะตะผะฐ: "Out of memory"

**ะะตัะตะฝะธะต:**
```python
# ะ clip_similarity_service.py ัะผะตะฝััะธัั batch size
# ะะปะธ ะธัะฟะพะปัะทะพะฒะฐัั faiss-gpu ะดะปั GPU ััะบะพัะตะฝะธั
```

---

## ๐ ะะะะะะะะะะ ะะะะะะกะ

### ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต (ัะตะบะพะผะตะฝะดัะตััั):

ะะพะฑะฐะฒะธัั ะฒ `coordinate_detector.py` ะฟะพัะปะต ัะพััะฐะฝะตะฝะธั ัะพัะพ:

```python
# ะะพัะปะต ััะฟะตัะฝะพะณะพ ะพะฟัะตะดะตะปะตะฝะธั ะบะพะพัะดะธะฝะฐั
if coordinates and os.path.exists(image_path):
    try:
        clip_service.add_image_to_index(
            image_path,
            metadata={
                'lat': coordinates['latitude'],
                'lon': coordinates['longitude'],
                'address': address_data
            }
        )
    except Exception as e:
        logger.error(f"Failed to add to CLIP index: {e}")
```

### ะััะฝะพะต ะพะฑะฝะพะฒะปะตะฝะธะต:

```bash
# ะะตัะตัะพะทะดะฐัั ะธะฝะดะตะบั ั ะฝะพะฒัะผะธ ัะพัะพ
python build_clip_index.py
```

---

## ๐ ะะะะะขะะะะะ

### ะัะพะฒะตัะบะฐ ััะฐัะธััะธะบะธ:

```python
from services.clip_similarity_service import CLIPSimilarityService

clip_service = CLIPSimilarityService()
stats = clip_service.get_statistics()
print(stats)
```

### ะะพะณะธ:

```bash
# ะกะผะพััะตัั ะปะพะณะธ CLIP
tail -f logs/backend.log | grep "CLIP"
```

**ะะถะธะดะฐะตะผัะต ะปะพะณะธ:**
```
INFO: ๐ Starting CLIP similarity search...
INFO: ๐ผ๏ธ CLIP: Found similar image with 0.89 similarity
```

---

## ๐ ะะขะะ

**ะกัะฐััั:** โ CLIP Image Similarity ะฟะพะปะฝะพัััั ะธะฝัะตะณัะธัะพะฒะฐะฝ

**ะงัะพ ะดะฐะปััะต:**
1. ะขะตััะธัะพะฒะฐะฝะธะต ะฝะฐ ัะตะฐะปัะฝัั ะดะฐะฝะฝัั
2. ะะฟัะธะผะธะทะฐัะธั ะฟะฐัะฐะผะตััะพะฒ (threshold, top_k)
3. Semantic Segmentation (ัะปะตะดัััะธะน ััะฐะฟ)

**ะะพัะพะฒะพ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั!** ๐
